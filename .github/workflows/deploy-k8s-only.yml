name: Deploy K8s Manifests Only

# T·ª± ƒë·ªông deploy khi c√≥ thay ƒë·ªïi trong th∆∞ m·ª•c k8s/
on:
  push:
    branches:
      - main
    paths:
      - 'k8s/**'
      - '.github/workflows/deploy-k8s-only.yml'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}

jobs:
  deploy-k8s-manifests:
    runs-on: ubuntu-latest
    
    steps:
      # ======================
      # 1) Checkout code
      # ======================
      - name: Checkout
        uses: actions/checkout@v4

      # ======================
      # 2) SSH Setup
      # ======================
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EKS_SSH_KEY }}

      - name: Add EKS server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EKS_SERVER_HOST }} >> ~/.ssh/known_hosts

      # ======================
      # 3) Replace placeholders in K8s manifests
      # ======================
      - name: Update K8s manifests with actual values
        run: |
          # Replace OWNER placeholder in all manifest files
          find k8s/ -type f -name "*.yaml" -exec sed -i "s/OWNER/${{ env.OWNER }}/g" {} +
          echo "‚úÖ Updated manifests with owner: ${{ env.OWNER }}"

      # ======================
      # 4) Sync K8s manifests to EKS server
      # ======================
      - name: Sync K8s manifests to EKS server
        env:
          SERVER_HOST: ${{ secrets.EKS_SERVER_HOST }}
          SERVER_USER: ${{ secrets.EKS_SERVER_USER }}
        run: |
          echo "üîÑ Syncing K8s manifests to EKS server..."
          ssh $SERVER_USER@$SERVER_HOST "mkdir -p ~/foodfast-k8s"
          
          # Sync all k8s files
          scp -r k8s/* $SERVER_USER@$SERVER_HOST:~/foodfast-k8s/
          
          echo "‚úÖ K8s manifests synced successfully"
          echo "üìÅ Synced files:"
          echo "  - base/ (namespace, configmap, secrets, monitoring)"
          echo "  - deployments/ (all app deployments)"
          echo "  - hpa/ (horizontal pod autoscaler)"
          echo "  - ingress/ (ingress rules)"

      # ======================
      # 5) Apply K8s manifests
      # ======================
      - name: Apply K8s manifests
        env:
          SERVER_HOST: ${{ secrets.EKS_SERVER_HOST }}
          SERVER_USER: ${{ secrets.EKS_SERVER_USER }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          OWNER: ${{ env.OWNER }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRE: ${{ secrets.JWT_EXPIRE }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST bash <<'ENDSSH'
          set -e
          
          cd ~/foodfast-k8s
          
          echo "üîß Configuring kubectl..."
          export KUBECONFIG=/home/ubuntu/.kube/config
          kubectl config use-context kind-foodfast || true
          
          echo "‚úÖ Cluster info:"
          kubectl cluster-info
          
          echo ""
          echo "üì¶ Applying base resources..."
          
          # Apply namespace first
          kubectl apply -f base/namespace.yaml
          
          # Update secrets if they exist
          if [ -f "base/secret.yaml" ]; then
            echo "üîê Applying secrets..."
            kubectl apply -f base/secret.yaml
          fi
          
          # Recreate secrets from environment variables
          echo "üîê Updating secrets from GitHub Secrets..."
          kubectl delete secret foodfast-secrets -n foodfast --ignore-not-found=true
          kubectl create secret generic foodfast-secrets \
            --from-literal=MONGO_URI="${MONGO_URI}" \
            --from-literal=JWT_SECRET="${JWT_SECRET}" \
            --from-literal=CLOUDINARY_CLOUD_NAME="${CLOUDINARY_CLOUD_NAME}" \
            --from-literal=CLOUDINARY_API_KEY="${CLOUDINARY_API_KEY}" \
            --from-literal=CLOUDINARY_API_SECRET="${CLOUDINARY_API_SECRET}" \
            --namespace=foodfast
          
          # Apply configmaps
          echo "‚öôÔ∏è  Applying ConfigMaps..."
          kubectl apply -f base/configmap.yaml
          kubectl apply -f base/nginx-config.yaml
          
          # Apply all deployments
          echo "üöÄ Applying deployments..."
          kubectl apply -f deployments/
          
          # Apply HPA
          echo "üìä Applying HPA..."
          kubectl apply -f hpa/
          
          # Apply Ingress
          echo "üåê Applying Ingress..."
          kubectl apply -f ingress/
          
          # Apply Monitoring
          echo "üìà Applying Monitoring Stack..."
          kubectl apply -f base/monitoring-prometheus.yaml
          kubectl apply -f base/monitoring-grafana.yaml
          
          # Update Grafana dashboard
          echo "üìä Updating Grafana dashboard..."
          kubectl create configmap grafana-dashboard-foodfast \
            --from-file=/home/ubuntu/foodfast-k8s/base/grafana-dashboard-foodfast.json \
            -n foodfast \
            --dry-run=client -o yaml | kubectl apply -f -
          
          # Restart Grafana to reload dashboard
          echo "üîÑ Restarting Grafana..."
          kubectl rollout restart deployment/grafana -n foodfast
          
          # Restart Prometheus to reload config
          echo "üîÑ Restarting Prometheus..."
          kubectl rollout restart deployment/prometheus -n foodfast
          
          echo ""
          echo "‚úÖ K8s manifests applied successfully!"
          echo ""
          echo "üìä Current Status:"
          kubectl get deployments -n foodfast
          echo ""
          kubectl get pods -n foodfast -o wide
          echo ""
          kubectl get svc -n foodfast
          echo ""
          echo "üéØ Monitoring URLs:"
          echo "  Prometheus: kubectl port-forward svc/prometheus 9090:9090 -n foodfast"
          echo "  Grafana: kubectl port-forward svc/grafana 3030:3000 -n foodfast"
          
          ENDSSH

      # ======================
      # 6) Verify deployment
      # ======================
      - name: Verify deployment
        env:
          SERVER_HOST: ${{ secrets.EKS_SERVER_HOST }}
          SERVER_USER: ${{ secrets.EKS_SERVER_USER }}
        run: |
          echo "‚è≥ Waiting 15 seconds for changes to take effect..."
          sleep 15
          
          echo ""
          echo "üìä Final deployment status:"
          ssh $SERVER_USER@$SERVER_HOST "kubectl get deployments -n foodfast"
          
          echo ""
          echo "üîç Pod status:"
          ssh $SERVER_USER@$SERVER_HOST "kubectl get pods -n foodfast"
          
          echo ""
          echo "üìù Recent events:"
          ssh $SERVER_USER@$SERVER_HOST "kubectl get events -n foodfast --sort-by='.lastTimestamp' | tail -10"
          
          echo ""
          echo "‚úÖ Deployment verification completed!"

name: Deploy Foodfast to Kubernetes on EC2

on:
  # T·ª± ch·∫°y sau khi workflow build image xong - CH·ªà NH√ÅNH MAIN
  workflow_run:
    workflows:
      - Docker Build and Push
    types:
      - completed
    branches:
      - main
  # Cho ph√©p b·∫•m tay ƒë·ªÉ deploy l·∫°i
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}

jobs:
  deploy:
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main') ||
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest

    steps:
      # ======================
      # 1) Checkout
      # ======================
      - name: Checkout (from workflow_run)
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Checkout (manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/checkout@v4

      - name: Verify branch is main
        if: github.event_name == 'workflow_run'
        run: |
          BRANCH_NAME=${{ github.event.workflow_run.head_branch }}
          echo "Triggering branch is: $BRANCH_NAME"
          if [ "$BRANCH_NAME" != "main" ]; then
            echo "Deployment is only allowed from the 'main' branch. Aborting."
            exit 1
          fi

      # ======================
      # 2) X√°c ƒë·ªãnh tag image
      # ======================
      - name: Decide image tag
        id: imagetag
        run: |
          TAG="latest"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "‚úÖ Will deploy image tag: $TAG (main branch only)"

      # ======================
      # 3) SSH Setup
      # ======================
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add EC2 to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts

      # ======================
      # 4) Generate K8s Manifests
      # ======================
      - name: Generate Kubernetes manifests
        env:
          IMAGE_TAG: ${{ steps.imagetag.outputs.tag }}
          REGISTRY: ${{ env.REGISTRY }}
          OWNER: ${{ env.OWNER }}
        run: |
          mkdir -p k8s-generated
          
          # Generate namespace
          cat > k8s-generated/00-namespace.yaml <<EOF
          apiVersion: v1
          kind: Namespace
          metadata:
            name: foodfast
          EOF
          
          # Generate secrets
          cat > k8s-generated/01-secrets.yaml <<EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: foodfast-secrets
            namespace: foodfast
          type: Opaque
          stringData:
            MONGO_URI: "${{ secrets.MONGO_URI }}"
            JWT_SECRET: "${{ secrets.JWT_SECRET }}"
            JWT_EXPIRE: "${{ secrets.JWT_EXPIRE }}"
            CLOUDINARY_CLOUD_NAME: "${{ secrets.CLOUDINARY_CLOUD_NAME }}"
            CLOUDINARY_API_KEY: "${{ secrets.CLOUDINARY_API_KEY }}"
            CLOUDINARY_API_SECRET: "${{ secrets.CLOUDINARY_API_SECRET }}"
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: ghcr-secret
            namespace: foodfast
          type: kubernetes.io/dockerconfigjson
          data:
            .dockerconfigjson: $(echo -n '{"auths":{"ghcr.io":{"auth":"'$(echo -n "${{ env.OWNER }}:${{ secrets.GHCR_TOKEN }}" | base64 -w 0)'"}}}' | base64 -w 0)
          EOF
          
          # Generate server deployment
          cat > k8s-generated/02-server.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foodfast-server
            namespace: foodfast
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: foodfast-server
            template:
              metadata:
                labels:
                  app: foodfast-server
              spec:
                imagePullSecrets:
                  - name: ghcr-secret
                containers:
                  - name: server
                    image: ${REGISTRY}/${OWNER}/foodfast-server:${IMAGE_TAG}
                    ports:
                      - containerPort: 5000
                    env:
                      - name: NODE_ENV
                        value: "production"
                      - name: PORT
                        value: "5000"
                      - name: MONGO_URI
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: MONGO_URI
                      - name: JWT_SECRET
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: JWT_SECRET
                      - name: JWT_EXPIRE
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: JWT_EXPIRE
                      - name: CLOUDINARY_CLOUD_NAME
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: CLOUDINARY_CLOUD_NAME
                      - name: CLOUDINARY_API_KEY
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: CLOUDINARY_API_KEY
                      - name: CLOUDINARY_API_SECRET
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: CLOUDINARY_API_SECRET
                    livenessProbe:
                      httpGet:
                        path: /health
                        port: 5000
                      initialDelaySeconds: 30
                      periodSeconds: 10
                    readinessProbe:
                      httpGet:
                        path: /health
                        port: 5000
                      initialDelaySeconds: 10
                      periodSeconds: 5
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "250m"
                      limits:
                        memory: "512Mi"
                        cpu: "500m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: foodfast-server
            namespace: foodfast
          spec:
            type: NodePort
            selector:
              app: foodfast-server
            ports:
              - port: 5000
                targetPort: 5000
                nodePort: 30500
          EOF
          
          # Generate client deployment
          cat > k8s-generated/03-client.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foodfast-client
            namespace: foodfast
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: foodfast-client
            template:
              metadata:
                labels:
                  app: foodfast-client
              spec:
                imagePullSecrets:
                  - name: ghcr-secret
                containers:
                  - name: client
                    image: ${REGISTRY}/${OWNER}/foodfast-client:${IMAGE_TAG}
                    ports:
                      - containerPort: 80
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "100m"
                      limits:
                        memory: "256Mi"
                        cpu: "200m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: foodfast-client
            namespace: foodfast
          spec:
            type: NodePort
            selector:
              app: foodfast-client
            ports:
              - port: 80
                targetPort: 80
                nodePort: 30300
          EOF
          
          # Generate admin deployment
          cat > k8s-generated/04-admin.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foodfast-admin
            namespace: foodfast
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: foodfast-admin
            template:
              metadata:
                labels:
                  app: foodfast-admin
              spec:
                imagePullSecrets:
                  - name: ghcr-secret
                containers:
                  - name: admin
                    image: ${REGISTRY}/${OWNER}/foodfast-admin:${IMAGE_TAG}
                    ports:
                      - containerPort: 80
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "100m"
                      limits:
                        memory: "256Mi"
                        cpu: "200m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: foodfast-admin
            namespace: foodfast
          spec:
            type: NodePort
            selector:
              app: foodfast-admin
            ports:
              - port: 80
                targetPort: 80
                nodePort: 30301
          EOF
          
          # Generate restaurant deployment
          cat > k8s-generated/05-restaurant.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foodfast-restaurant
            namespace: foodfast
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: foodfast-restaurant
            template:
              metadata:
                labels:
                  app: foodfast-restaurant
              spec:
                imagePullSecrets:
                  - name: ghcr-secret
                containers:
                  - name: restaurant
                    image: ${REGISTRY}/${OWNER}/foodfast-restaurant:${IMAGE_TAG}
                    ports:
                      - containerPort: 80
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "100m"
                      limits:
                        memory: "256Mi"
                        cpu: "200m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: foodfast-restaurant
            namespace: foodfast
          spec:
            type: NodePort
            selector:
              app: foodfast-restaurant
            ports:
              - port: 80
                targetPort: 80
                nodePort: 30302
          EOF
          
          # Generate drone deployment
          cat > k8s-generated/06-drone.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foodfast-drone
            namespace: foodfast
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: foodfast-drone
            template:
              metadata:
                labels:
                  app: foodfast-drone
              spec:
                imagePullSecrets:
                  - name: ghcr-secret
                containers:
                  - name: drone
                    image: ${REGISTRY}/${OWNER}/foodfast-drone:${IMAGE_TAG}
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "100m"
                      limits:
                        memory: "256Mi"
                        cpu: "200m"
          EOF
          
          # Generate monitoring stack
          cat > k8s-generated/07-monitoring.yaml <<EOF
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: prometheus-config
            namespace: foodfast
          data:
            prometheus.yml: |
              global:
                scrape_interval: 15s
                evaluation_interval: 15s
              scrape_configs:
                - job_name: 'kubernetes-nodes'
                  kubernetes_sd_configs:
                    - role: node
                - job_name: 'kubernetes-pods'
                  kubernetes_sd_configs:
                    - role: pod
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: prometheus
            namespace: foodfast
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: prometheus
            template:
              metadata:
                labels:
                  app: prometheus
              spec:
                containers:
                  - name: prometheus
                    image: prom/prometheus:latest
                    ports:
                      - containerPort: 9090
                    volumeMounts:
                      - name: config
                        mountPath: /etc/prometheus
                    resources:
                      requests:
                        memory: "512Mi"
                        cpu: "250m"
                      limits:
                        memory: "1Gi"
                        cpu: "500m"
                volumes:
                  - name: config
                    configMap:
                      name: prometheus-config
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: prometheus
            namespace: foodfast
          spec:
            type: NodePort
            selector:
              app: prometheus
            ports:
              - port: 9090
                targetPort: 9090
                nodePort: 30909
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: grafana
            namespace: foodfast
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: grafana
            template:
              metadata:
                labels:
                  app: grafana
              spec:
                containers:
                  - name: grafana
                    image: grafana/grafana:latest
                    ports:
                      - containerPort: 3000
                    env:
                      - name: GF_SECURITY_ADMIN_PASSWORD
                        value: "admin123"
                      - name: GF_USERS_ALLOW_SIGN_UP
                        value: "false"
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "200m"
                      limits:
                        memory: "512Mi"
                        cpu: "400m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: grafana
            namespace: foodfast
          spec:
            type: NodePort
            selector:
              app: grafana
            ports:
              - port: 3000
                targetPort: 3000
                nodePort: 30303
          EOF
          
          echo "‚úÖ K8s manifests generated"

      # ======================
      # 5) Copy manifests to EC2 & Deploy
      # ======================
      - name: Deploy to Kubernetes on EC2
        env:
          SERVER_HOST: ${{ secrets.PROD_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PROD_SERVER_USER }}
        run: |
          echo "üì¶ Copying K8s manifests to EC2..."
          ssh $SERVER_USER@$SERVER_HOST "mkdir -p ~/k8s-foodfast"
          scp -r k8s-generated/* $SERVER_USER@$SERVER_HOST:~/k8s-foodfast/
          
          echo "üöÄ Deploying to Kubernetes..."
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            
            # Check if kubectl is installed
            if ! command -v kubectl &> /dev/null; then
              echo "‚ö†Ô∏è  kubectl not found. Installing..."
              curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
              sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
              rm kubectl
            fi
            
            # Check if k3s is running
            if ! sudo systemctl is-active --quiet k3s 2>/dev/null; then
              echo "‚ö†Ô∏è  k3s not found. Installing lightweight Kubernetes..."
              curl -sfL https://get.k3s.io | sh -
              sudo systemctl enable k3s
              sudo systemctl start k3s
              sleep 10
            fi
            
            # Setup kubectl config
            mkdir -p ~/.kube
            sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            sudo chown $(id -u):$(id -g) ~/.kube/config
            export KUBECONFIG=~/.kube/config
            
            # Apply manifests
            echo "üìã Applying Kubernetes manifests..."
            kubectl apply -f ~/k8s-foodfast/
            
            # Wait for deployments
            echo "‚è≥ Waiting for deployments to be ready..."
            kubectl wait --for=condition=available --timeout=300s deployment --all -n foodfast || true
            
            # Show status
            echo "üìä Deployment status:"
            kubectl get all -n foodfast
            
            echo "‚úÖ Kubernetes deployment complete!"
          ENDSSH

      # ======================
      # 6) Healthcheck
      # ======================
      - name: Healthcheck services
        run: |
          echo "‚è≥ Waiting for services to be ready..."
          sleep 30
          
          echo "üîç Checking backend health..."
          for i in {1..10}; do
            echo "Attempt $i"
            if curl -f http://${{ secrets.PROD_SERVER_HOST }}:30500/health \
              || curl -f http://${{ secrets.PROD_SERVER_HOST }}:30500/api/health \
              || curl -f http://${{ secrets.PROD_SERVER_HOST }}:30500/ ; then
              echo "‚úÖ Backend is up on NodePort 30500"
              exit 0
            fi
            sleep 5
          done
          echo "‚ö†Ô∏è  Backend healthcheck failed, but deployment may still be starting"
          exit 0

name: Auto Deploy Foodfast to EC2

on:
  # ch·∫°y t·ª± ƒë·ªông sau khi workflow build image xong
  workflow_run:
    workflows:
      - Docker Build and Push     # ‚ö†Ô∏è ƒë√∫ng t√™n workflow build c·ªßa b·∫°n
    types:
      - completed
  # cho ph√©p b·∫•m tay
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}

jobs:
  # =====================================================
  # 1) JOB D√í NH√ÅNH TH·∫¨T C·ª¶A L·∫¶N BUILD V·ª™A XONG
  # =====================================================
  detect-source:
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.pick-branch.outputs.branch }}
      should_deploy: ${{ steps.decide.outputs.should_deploy }}
    steps:
      # L·∫•y branch t·ª´ run g·ªëc (workflow_run) = c√°ch ch·∫Øc ƒÉn nh·∫•t
      - name: Get branch from original run (only when workflow_run)
        id: get-from-run
        if: ${{ github.event_name == 'workflow_run' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RUN_ID=${{ github.event.workflow_run.id }}
          # H·ªèi l·∫°i GitHub: c√°i run n√†y th·ª±c s·ª± ch·∫°y t·ª´ branch n√†o?
          BRANCH=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID --jq .head_branch)
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Original run branch: $BRANCH"

      # N·∫øu l√† b·∫•m tay th√¨ ta coi nh∆∞ deploy main
      - name: Get branch for manual dispatch
        id: get-from-dispatch
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "branch=main" >> $GITHUB_OUTPUT

      # G·ªôp 2 nh√°nh l·∫•y branch ·ªü tr√™n th√†nh 1 output duy nh·∫•t
      - name: Pick branch
        id: pick-branch
        run: |
          BRANCH="${{ steps.get-from-run.outputs.branch }}"
          if [ -z "$BRANCH" ]; then
            BRANCH="${{ steps.get-from-dispatch.outputs.branch }}"
          fi
          echo "üëâ Final detected branch: $BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      # Quy·∫øt ƒë·ªãnh c√≥ deploy kh√¥ng
      - name: Decide should deploy
        id: decide
        run: |
          BRANCH="${{ steps.pick-branch.outputs.branch }}"
          if [ "$BRANCH" = "main" ]; then
            echo "‚úÖ This is main. Will deploy."
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "‚õî Not main ($BRANCH). Skip deploy."
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  # =====================================================
  # 2) JOB DEPLOY - ch·ªâ ch·∫°y khi should_deploy == true
  # =====================================================
  deploy:
    needs: detect-source
    if: ${{ needs.detect-source.outputs.should_deploy == 'true' }}
    runs-on: ubuntu-latest

    steps:
      # ======================
      # 1) Checkout
      # ======================
      - name: Checkout (from workflow_run)
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/checkout@v4
        with:
          # checkout ƒë√∫ng commit build ra image
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Checkout (manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/checkout@v4

      # ======================
      # 2) Decide image tag
      # ======================
      - name: Decide image tag
        id: imagetag
        run: |
          TAG="latest"   # ch·ªâ deploy main
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "‚úÖ Will deploy image tag: $TAG"

      # ======================
      # 3) SSH Setup
      # ======================
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add EC2 to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts

      # ======================
      # 4) Create remote script
      # ======================
      - name: Create remote script
        run: |
          cat > remote-deploy.sh <<'SCRIPT'
          set -e

          REGISTRY="${REGISTRY}"
          OWNER="${OWNER}"
          IMAGE_TAG="${IMAGE_TAG}"
          GHCR_TOKEN="${GHCR_TOKEN}"
          MONGO_URI="${MONGO_URI}"
          JWT_SECRET="${JWT_SECRET}"
          JWT_EXPIRE="${JWT_EXPIRE}"

          echo "==> Login GHCR as \$OWNER"
          echo "${GHCR_TOKEN}" | sudo docker login ghcr.io -u "${OWNER}" --password-stdin

          echo "==> Create network"
          sudo docker network create foodfast-net || true

          echo "=== Deploy foodfast-server:\${IMAGE_TAG} ==="
          sudo docker pull "${REGISTRY}/${OWNER}/foodfast-server:${IMAGE_TAG}"
          sudo docker rm -f foodfast-server 2>/dev/null || true
          sudo docker run -d --name foodfast-server --restart unless-stopped \
            --network foodfast-net --network-alias server_app \
            -p 5000:5000 \
            -e MONGO_URI="${MONGO_URI}" \
            -e JWT_SECRET="${JWT_SECRET}" \
            -e JWT_EXPIRE="${JWT_EXPIRE}" \
            -e NODE_ENV="production" \
            -e PORT="5000" \
            "${REGISTRY}/${OWNER}/foodfast-server:${IMAGE_TAG}"

          echo "=== Deploy foodfast-client:\${IMAGE_TAG} ==="
          sudo docker pull "${REGISTRY}/${OWNER}/foodfast-client:${IMAGE_TAG}"
          sudo docker rm -f foodfast-client 2>/dev/null || true
          sudo docker run -d --name foodfast-client --restart unless-stopped \
            --network foodfast-net \
            -p 3000:80 \
            "${REGISTRY}/${OWNER}/foodfast-client:${IMAGE_TAG}"

          echo "=== Deploy foodfast-admin:\${IMAGE_TAG} ==="
          sudo docker pull "${REGISTRY}/${OWNER}/foodfast-admin:${IMAGE_TAG}"
          sudo docker rm -f foodfast-admin 2>/dev/null || true
          sudo docker run -d --name foodfast-admin --restart unless-stopped \
            --network foodfast-net \
            -p 3001:80 \
            "${REGISTRY}/${OWNER}/foodfast-admin:${IMAGE_TAG}"

          echo "=== Deploy foodfast-restaurant:\${IMAGE_TAG} ==="
          sudo docker pull "${REGISTRY}/${OWNER}/foodfast-restaurant:${IMAGE_TAG}"
          sudo docker rm -f foodfast-restaurant 2>/dev/null || true
          sudo docker run -d --name foodfast-restaurant --restart unless-stopped \
            --network foodfast-net \
            -p 3002:80 \
            "${REGISTRY}/${OWNER}/foodfast-restaurant:${IMAGE_TAG}"

          echo "=== Deploy foodfast-drone:\${IMAGE_TAG} ==="
          sudo docker pull "${REGISTRY}/${OWNER}/foodfast-drone:${IMAGE_TAG}"
          sudo docker rm -f foodfast-drone 2>/dev/null || true
          sudo docker run -d --name foodfast-drone --restart unless-stopped \
            --network foodfast-net \
            "${REGISTRY}/${OWNER}/foodfast-drone:${IMAGE_TAG}"

          echo "‚úÖ Deploy done."
          SCRIPT

      # ======================
      # 5) Run remote script on EC2
      # ======================
      - name: Run remote script on EC2
        env:
          SERVER_HOST: ${{ secrets.PROD_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PROD_SERVER_USER }}
          REGISTRY: ${{ env.REGISTRY }}
          OWNER: ${{ env.OWNER }}
          IMAGE_TAG: ${{ steps.imagetag.outputs.tag }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRE: ${{ secrets.JWT_EXPIRE }}
        run: |
          echo "Connecting to $SERVER_USER@$SERVER_HOST ..."
          echo "Deploying with image tag: ${IMAGE_TAG}"

          scp remote-deploy.sh $SERVER_USER@$SERVER_HOST:/tmp/remote-deploy.sh

          ssh $SERVER_USER@$SERVER_HOST "chmod +x /tmp/remote-deploy.sh && \
            REGISTRY='${REGISTRY}' \
            OWNER='${OWNER}' \
            IMAGE_TAG='${IMAGE_TAG}' \
            GHCR_TOKEN='${GHCR_TOKEN}' \
            MONGO_URI='${MONGO_URI}' \
            JWT_SECRET='${JWT_SECRET}' \
            JWT_EXPIRE='${JWT_EXPIRE}' \
            /tmp/remote-deploy.sh"

      # ======================
      # 6) Healthcheck
      # ======================
      - name: Healthcheck backend
        run: |
          echo "Waiting for backend..."
          for i in {1..6}; do
            echo "Attempt $i"
            if curl -f http://${{ secrets.PROD_SERVER_HOST }}:5000/health \
              || curl -f http://${{ secrets.PROD_SERVER_HOST }}:5000/api/health \
              || curl -f http://${{ secrets.PROD_SERVER_HOST }}:5000/ ; then
              echo "‚úÖ Backend is up"
              exit 0
            fi
            sleep 5
          done
          echo "‚ùå Backend is NOT responding on port 5000"
          exit 1

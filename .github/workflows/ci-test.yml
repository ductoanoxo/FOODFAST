name: CI - Test and Lint (Deploy Branch - Testing Conflict)

on:
  push:
    branches:
      - main
      - develop
      - DUCTOAN
      - kiet
      - deploy
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  security-events: write

jobs:
  test-server:
    name: Test Server App
    runs-on: ubuntu-latest
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: admin123
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # DÃ¹ng cho CÃCH 3 (Ä‘áº©y log test lÃªn CloudWatch)
      - name: Configure AWS credentials (for CloudWatch)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: server_app/package-lock.json

      - name: Install dependencies
        working-directory: ./server_app
        run: npm ci

      - name: Run linting
        working-directory: ./server_app
        run: npm run lint || echo "âš ï¸  Linting warnings found but continuing"

      - name: Run Unit Tests (Must Pass 100%)
        working-directory: ./server_app
        env:
          NODE_ENV: test
          MONGO_URI: mongodb://admin:admin123@localhost:27017/foodfast_test?authSource=admin
          JWT_SECRET: test-secret-key
        run: |
          echo "=========================================="
          echo "ðŸ§ª Running Server Unit Tests"
          echo "=========================================="
          npm run test:unit 2>&1 | tee test-output.log
          
          if grep -q "No tests found" test-output.log || grep -q "0 tests" test-output.log; then
            echo "âš ï¸  No unit tests found - will add later"
            exit 0
          elif grep -E "Test Suites:.*[0-9]+ failed" test-output.log || grep -E "Tests:.*[0-9]+ failed" test-output.log; then
            echo "âŒ Unit tests failed"
            exit 1
          else
            echo "âœ… Unit tests passed"
          fi

      - name: Run Integration Tests (Must Pass 100%)
        working-directory: ./server_app
        env:
          NODE_ENV: test
          MONGO_URI: mongodb://admin:admin123@localhost:27017/foodfast_test?authSource=admin
          JWT_SECRET: test-secret-key
        run: |
          echo "=========================================="
          echo "ðŸ§ª Running Server Integration Tests"
          echo "=========================================="
          npm run test:integration 2>&1 | tee integration-output.log
          
          if grep -q "No tests found" integration-output.log || grep -q "0 tests" integration-output.log; then
            echo "âš ï¸  No integration tests found - will add later"
            exit 0
          elif grep -E "Test Suites:.*[0-9]+ failed" integration-output.log || grep -E "Tests:.*[0-9]+ failed" integration-output.log; then
            echo "âŒ Integration tests failed"
            exit 1
          else
            echo "âœ… Integration tests passed"
          fi

      - name: Generate Coverage Report
        working-directory: ./server_app
        env:
          NODE_ENV: test
          MONGO_URI: mongodb://admin:admin123@localhost:27017/foodfast_test?authSource=admin
          JWT_SECRET: test-secret-key
        run: |
          echo "=========================================="
          echo "ðŸ“Š Generating Coverage Report for Server"
          echo "=========================================="
          npm run test:coverage 2>&1 | tee coverage-output.log || echo "âš ï¸  Coverage generation skipped"


      - name: Upload Server Coverage
        uses: codecov/codecov-action@v4
        if: success()
        with:
          files: ./server_app/coverage/coverage-final.json
          flags: server_app
          name: server_app-coverage
          fail_ci_if_error: false
        continue-on-error: true

      # â­ CÃCH 1: hiá»‡n log test ngay trong tab Summary
      - name: Add server test logs to job summary
        if: always()
        run: |
          {
            echo "## ðŸ§ª Server tests (failed only + coverage)"

            echo
            echo "### âŒ Server Unit test failures"
            echo '```text'
            if [ -f server_app/test-output.log ]; then
              CLEAN=$(cat server_app/test-output.log | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')

              # Chá»‰ in block quanh cÃ¡c dÃ²ng FAIL
              printf "%s\n" "$CLEAN" | grep -A50 '^FAIL ' || echo "No failed unit tests."

              echo
              # ThÃªm dÃ²ng summary Test Suites / Tests / Snapshots (náº¿u cÃ³)
              printf "%s\n" "$CLEAN" | grep -E 'Test Suites:|Tests:|Snapshots:' || true
            else
              echo "No unit test log file found."
            fi
            echo '```'

            echo
            echo "### âŒ Server Integration test failures"
            echo '```text'
            if [ -f server_app/integration-output.log ]; then
              CLEAN=$(cat server_app/integration-output.log | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')

              printf "%s\n" "$CLEAN" | grep -A50 '^FAIL ' || echo "No failed integration tests."

              echo
              printf "%s\n" "$CLEAN" | grep -E 'Test Suites:|Tests:|Snapshots:' || true
            else
              echo "No integration test log file found."
            fi
            echo '```'

            echo
            echo "### ðŸ“Š Server coverage summary"
            echo '```text'
            if [ -f server_app/coverage-output.log ]; then
              CLEAN_COV=$(cat server_app/coverage-output.log | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')
              # Láº¥y pháº§n summary tá»« dÃ²ng 'All files' trá»Ÿ Ä‘i, náº¿u khÃ´ng cÃ³ thÃ¬ láº¥y 40 dÃ²ng cuá»‘i
              COVERAGE=$(printf "%s\n" "$CLEAN_COV" | sed -n '/All files/,$p')
              if [ -z "$COVERAGE" ]; then
                COVERAGE=$(printf "%s\n" "$CLEAN_COV" | tail -n 40)
              fi
              printf "%s\n" "$COVERAGE"
            else
              echo "No coverage log file found."
            fi
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"


      # â­ CÃCH 3: Ä‘áº©y log test server lÃªn CloudWatch Logs (chá»‰ khi FAIL)
      - name: Push server test logs to CloudWatch (on failure)
        if: failure()
        run: |
          LOG_GROUP="/ci/server-tests"
          LOG_STREAM="${GITHUB_RUN_ID}-server"

          aws logs create-log-group --log-group-name "$LOG_GROUP" 2>/dev/null || true
          aws logs create-log-stream --log-group-name "$LOG_GROUP" --log-stream-name "$LOG_STREAM" 2>/dev/null || true

          TS=$(($(date +%s%N)/1000000))

          LOG_TEXT=$(
            {
              echo "=== Server Unit test failures ==="
              if [ -f server_app/test-output.log ]; then
                CLEAN=$(cat server_app/test-output.log | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')
                printf "%s\n" "$CLEAN" | grep -A50 '^FAIL ' || echo "No failed unit tests."
                printf "%s\n" "$CLEAN" | grep -E 'Test Suites:|Tests:|Snapshots:' || true
              else
                echo "No unit test log file found."
              fi

              echo
              echo "=== Server Integration test failures ==="
              if [ -f server_app/integration-output.log ]; then
                CLEAN=$(cat server_app/integration-output.log | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')
                printf "%s\n" "$CLEAN" | grep -A50 '^FAIL ' || echo "No failed integration tests."
                printf "%s\n" "$CLEAN" | grep -E 'Test Suites:|Tests:|Snapshots:' || true
              else
                echo "No integration test log file found."
              fi

              echo
              echo "=== Server Coverage summary ==="
              if [ -f server_app/coverage-output.log ]; then
                CLEAN_COV=$(cat server_app/coverage-output.log | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')
                COVERAGE=$(printf "%s\n" "$CLEAN_COV" | sed -n '/All files/,$p')
                if [ -z "$COVERAGE" ]; then
                  COVERAGE=$(printf "%s\n" "$CLEAN_COV" | tail -n 40)
                fi
                printf "%s\n" "$COVERAGE"
              else
                echo "No coverage log file found."
              fi
            }
          )

          ESCAPED=$(python -c "import json,sys; print(json.dumps(sys.stdin.read())[1:-1])" <<< "$LOG_TEXT")

          aws logs put-log-events \
            --log-group-name "$LOG_GROUP" \
            --log-stream-name "$LOG_STREAM" \
            --log-events "[{\"timestamp\":$TS,\"message\":\"$ESCAPED\"}]"


  test-client-apps:
    name: Test Frontend Apps
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        app:
          - client_app
          - restaurant_app
          - admin_app
          - drone_manage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Cho CloudWatch á»Ÿ job frontend
      - name: Configure AWS credentials (for CloudWatch)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.app }}/package-lock.json

      - name: Install dependencies
        working-directory: ./${{ matrix.app }}
        run: npm ci

      - name: Run Unit Tests (Must Pass 100%)
        working-directory: ./${{ matrix.app }}
        env:
          NODE_ENV: test
          CI: true
        run: |
          echo "=========================================="
          echo "ðŸ§ª Running Unit Tests for ${{ matrix.app }}"
          echo "=========================================="
          if [ -f "package.json" ] && grep -q "test:unit" package.json; then
            npm run test:unit 2>&1 | tee test-output.log
            
            if grep -q "No test files found" test-output.log || grep -q "Test Files.*0" test-output.log || grep -q "no tests" test-output.log; then
              echo "âš ï¸  No unit tests found for ${{ matrix.app }} - will add later"
              exit 0
            elif grep -E "Test Suites:.*[0-9]+ failed" test-output.log || grep -E "Tests:.*[0-9]+ failed" test-output.log || grep -E "Test Files.*[0-9]+ failed" test-output.log; then
              echo "âŒ Unit tests failed for ${{ matrix.app }}"
              exit 1
            elif grep -q "skipped" test-output.log; then
              echo "âš ï¸  Some unit tests are skipped for ${{ matrix.app }}"
              echo "âš ï¸  Please remove .skip or implement the tests"
              grep "skipped" test-output.log
            fi
            echo "âœ… Unit tests passed for ${{ matrix.app }}"
          else
            echo "âš ï¸  No unit tests configured for ${{ matrix.app }} - will add later"
          fi

      - name: Run Integration Tests (Must Pass 100%)
        working-directory: ./${{ matrix.app }}
        env:
          NODE_ENV: test
          CI: true
        run: |
          echo "=========================================="
          echo "ðŸ§ª Running Integration Tests for ${{ matrix.app }}"
          echo "=========================================="
          if [ -f "package.json" ] && grep -q "test:integration" package.json; then
            npm run test:integration 2>&1 | tee integration-output.log
            
            if grep -q "no tests" integration-output.log || grep -q "Test Files.*0" integration-output.log || grep -q "No test files found" integration-output.log; then
              echo "âš ï¸  No integration tests found for ${{ matrix.app }} - will add later"
              exit 0
            elif grep -E "Test Suites:.*[0-9]+ failed" integration-output.log || grep -E "Tests:.*[0-9]+ failed" integration-output.log || grep -E "Test Files.*[0-9]+ failed" integration-output.log; then
              echo "âŒ Integration tests failed for ${{ matrix.app }}"
              cat integration-output.log
              exit 1
            elif grep -q "Errors.*error" integration-output.log; then
              echo "âŒ Integration tests have errors for ${{ matrix.app }}"
              cat integration-output.log
              exit 1
            elif grep -q "skipped" integration-output.log; then
              echo "âš ï¸  Some integration tests are skipped for ${{ matrix.app }}"
              echo "âš ï¸  Please remove .skip or implement the tests"
              grep "skipped" integration-output.log
            fi
            echo "âœ… Integration tests passed for ${{ matrix.app }}"
          else
            echo "âš ï¸  No integration tests configured for ${{ matrix.app }} - will add later"
          fi

      - name: Generate Coverage Report
        working-directory: ./${{ matrix.app }}
        env:
          NODE_ENV: test
          CI: true
        run: |
          echo "=========================================="
          echo "ðŸ“Š Generating Coverage Report for ${{ matrix.app }}"
          echo "=========================================="
          if [ -f "package.json" ] && grep -q "test:coverage" package.json; then
            npm run test:coverage 2>&1 | tee coverage-output.log || echo "âš ï¸  Coverage generation skipped for ${{ matrix.app }}"
          else
            echo "âš ï¸  Coverage not configured for ${{ matrix.app }}"
          fi


      - name: Upload Coverage Reports
        uses: codecov/codecov-action@v4
        if: success()
        with:
          files: ./${{ matrix.app }}/coverage/coverage-final.json
          flags: ${{ matrix.app }}
          name: ${{ matrix.app }}-coverage
          fail_ci_if_error: false
        continue-on-error: true

      - name: Run linting
        working-directory: ./${{ matrix.app }}
        run: npm run lint || echo "âš ï¸  No linting configured for ${{ matrix.app }}"

      - name: Build application
        working-directory: ./${{ matrix.app }}
        run: npm run build

      # CÃCH 1 cho frontend: hiá»‡n log trong Summary
      # CÃCH 1 cho frontend: hiá»‡n log trong Summary (chá»‰ fail + coverage)
      - name: Add frontend test logs to job summary
        if: always()
        run: |
          APP_DIR="${{ matrix.app }}"
          {
            echo "## ðŸ§ª Frontend tests for ${APP_DIR} (failed only + coverage)"

            echo
            echo "### âŒ Unit test failures"
            echo '```text'
            if [ -f "${APP_DIR}/test-output.log" ]; then
              CLEAN=$(cat "${APP_DIR}/test-output.log" | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')

              printf "%s\n" "$CLEAN" | grep -A50 '^FAIL ' || echo "No failed unit tests."
              echo
              printf "%s\n" "$CLEAN" | grep -E 'Test Suites:|Tests:|Snapshots:' || true
            else
              echo "No unit test log file found."
            fi
            echo '```'

            echo
            echo "### âŒ Integration test failures"
            echo '```text'
            if [ -f "${APP_DIR}/integration-output.log" ]; then
              CLEAN=$(cat "${APP_DIR}/integration-output.log" | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')

              printf "%s\n" "$CLEAN" | grep -A50 '^FAIL ' || echo "No failed integration tests."
              echo
              printf "%s\n" "$CLEAN" | grep -E 'Test Suites:|Tests:|Snapshots:' || true
            else
              echo "No integration test log file found."
            fi
            echo '```'

            echo
            echo "### ðŸ“Š Coverage summary"
            echo '```text'
            if [ -f "${APP_DIR}/coverage-output.log" ]; then
              CLEAN_COV=$(cat "${APP_DIR}/coverage-output.log" | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')
              COVERAGE=$(printf "%s\n" "$CLEAN_COV" | sed -n '/All files/,$p')
              if [ -z "$COVERAGE" ]; then
                COVERAGE=$(printf "%s\n" "$CLEAN_COV" | tail -n 40)
              fi
              printf "%s\n" "$COVERAGE"
            else
              echo "No coverage log file found."
            fi
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"



      # CÃCH 3 cho frontend: Ä‘áº©y log lÃªn CloudWatch khi FAIL
      # CÃCH 3 cho frontend: Ä‘áº©y log lÃªn CloudWatch khi FAIL (chá»‰ fail + coverage)
      - name: Push frontend test logs to CloudWatch (on failure)
        if: failure()
        env:
          APP_NAME: ${{ matrix.app }}
        run: |
          LOG_GROUP="/ci/frontend-tests"
          LOG_STREAM="${GITHUB_RUN_ID}-${APP_NAME}"

          aws logs create-log-group --log-group-name "$LOG_GROUP" 2>/dev/null || true
          aws logs create-log-stream --log-group-name "$LOG_GROUP" --log-stream-name "$LOG_STREAM" 2>/dev/null || true

          TS=$(($(date +%s%N)/1000000))

          LOG_TEXT=$(
            {
              echo "=== Frontend (${APP_NAME}) Unit test failures ==="
              if [ -f "${APP_NAME}/test-output.log" ]; then
                CLEAN=$(cat "${APP_NAME}/test-output.log" | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')
                printf "%s\n" "$CLEAN" | grep -A50 '^FAIL ' || echo "No failed unit tests."
                printf "%s\n" "$CLEAN" | grep -E 'Test Suites:|Tests:|Snapshots:' || true
              else
                echo "No unit test log file found."
              fi

              echo
              echo "=== Frontend (${APP_NAME}) Integration test failures ==="
              if [ -f "${APP_NAME}/integration-output.log" ]; then
                CLEAN=$(cat "${APP_NAME}/integration-output.log" | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')
                printf "%s\n" "$CLEAN" | grep -A50 '^FAIL ' || echo "No failed integration tests."
                printf "%s\n" "$CLEAN" | grep -E 'Test Suites:|Tests:|Snapshots:' || true
              else
                echo "No integration test log file found."
              fi

              echo
              echo "=== Frontend (${APP_NAME}) Coverage summary ==="
              if [ -f "${APP_NAME}/coverage-output.log" ]; then
                CLEAN_COV=$(cat "${APP_NAME}/coverage-output.log" | tr '\r' '\n' | sed -r 's/\x1B\[[0-9;]*[mK]//g')
                COVERAGE=$(printf "%s\n" "$CLEAN_COV" | sed -n '/All files/,$p')
                if [ -z "$COVERAGE" ]; then
                  COVERAGE=$(printf "%s\n" "$CLEAN_COV" | tail -n 40)
                fi
                printf "%s\n" "$COVERAGE"
              else
                echo "No coverage log file found."
              fi
            }
          )

          ESCAPED=$(python -c "import json,sys; print(json.dumps(sys.stdin.read())[1:-1])" <<< "$LOG_TEXT")

          aws logs put-log-events \
            --log-group-name "$LOG_GROUP" \
            --log-stream-name "$LOG_STREAM" \
            --log-events "[{\"timestamp\":$TS,\"message\":\"$ESCAPED\"}]"


  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always() && github.repository == github.event.repository.full_name
        with:
          sarif_file: 'trivy-results.sarif'

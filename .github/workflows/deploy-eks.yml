name: Deploy Foodfast to AWS EKS

on:
  # T·ª± ch·∫°y sau khi workflow build image xong - CH·ªà NH√ÅNH MAIN
  workflow_run:
    workflows:
      - Docker Build and Push
    types:
      - completed
    branches:
      - main
  # Cho ph√©p b·∫•m tay ƒë·ªÉ deploy l·∫°i
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  OWNER: ${{ github.repository_owner }}
  AWS_REGION: us-east-1
  CLUSTER_NAME: foodfast-cluster

jobs:
  deploy:
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main') ||
      (github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main')
    runs-on: ubuntu-latest

    steps:
      # ======================
      # 1) Checkout
      # ======================
      - name: Checkout (from workflow_run)
        if: ${{ github.event_name == 'workflow_run' }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Checkout (manual)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/checkout@v4

      - name: Verify branch is main
        if: github.event_name == 'workflow_run'
        run: |
          BRANCH_NAME=${{ github.event.workflow_run.head_branch }}
          echo "Triggering branch is: $BRANCH_NAME"
          if [ "$BRANCH_NAME" != "main" ]; then
            echo "Deployment is only allowed from the 'main' branch. Aborting."
            exit 1
          fi

      # ======================
      # 2) X√°c ƒë·ªãnh tag image
      # ======================
      - name: Decide image tag
        id: imagetag
        run: |
          TAG="latest"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "‚úÖ Will deploy image tag: $TAG (main branch only)"

      # ======================
      # 3) Configure AWS credentials
      # ======================
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # ======================
      # 4) Setup kubectl
      # ======================
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      # ======================
      # 5) Update kubeconfig for EKS
      # ======================
      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.CLUSTER_NAME }} --region ${{ env.AWS_REGION }}
          kubectl version --client
          kubectl get nodes

      # ======================
      # 6) Generate K8s manifests with secrets
      # ======================
      - name: Generate Kubernetes manifests
        env:
          IMAGE_TAG: ${{ steps.imagetag.outputs.tag }}
          REGISTRY: ${{ env.REGISTRY }}
          OWNER: ${{ env.OWNER }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRE: ${{ secrets.JWT_EXPIRE }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          mkdir -p k8s-deploy
          
          # Namespace
          cat > k8s-deploy/00-namespace.yaml <<EOF
          apiVersion: v1
          kind: Namespace
          metadata:
            name: foodfast
          EOF
          
          # Secrets
          cat > k8s-deploy/01-secrets.yaml <<EOF
          apiVersion: v1
          kind: Secret
          metadata:
            name: foodfast-secrets
            namespace: foodfast
          type: Opaque
          stringData:
            MONGO_URI: "${MONGO_URI}"
            JWT_SECRET: "${JWT_SECRET}"
            JWT_EXPIRE: "${JWT_EXPIRE}"
            CLOUDINARY_CLOUD_NAME: "${CLOUDINARY_CLOUD_NAME}"
            CLOUDINARY_API_KEY: "${CLOUDINARY_API_KEY}"
            CLOUDINARY_API_SECRET: "${CLOUDINARY_API_SECRET}"
          ---
          apiVersion: v1
          kind: Secret
          metadata:
            name: ghcr-secret
            namespace: foodfast
          type: kubernetes.io/dockerconfigjson
          data:
            .dockerconfigjson: $(echo -n '{"auths":{"ghcr.io":{"auth":"'$(echo -n "${OWNER}:${GHCR_TOKEN}" | base64 -w 0)'"}}}' | base64 -w 0)
          EOF
          
          # Server
          cat > k8s-deploy/02-server.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foodfast-server
            namespace: foodfast
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: foodfast-server
            template:
              metadata:
                labels:
                  app: foodfast-server
              spec:
                imagePullSecrets:
                  - name: ghcr-secret
                containers:
                  - name: server
                    image: ${REGISTRY}/${OWNER}/foodfast-server:${IMAGE_TAG}
                    ports:
                      - containerPort: 5000
                    env:
                      - name: NODE_ENV
                        value: "production"
                      - name: PORT
                        value: "5000"
                      - name: MONGO_URI
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: MONGO_URI
                      - name: JWT_SECRET
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: JWT_SECRET
                      - name: JWT_EXPIRE
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: JWT_EXPIRE
                      - name: CLOUDINARY_CLOUD_NAME
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: CLOUDINARY_CLOUD_NAME
                      - name: CLOUDINARY_API_KEY
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: CLOUDINARY_API_KEY
                      - name: CLOUDINARY_API_SECRET
                        valueFrom:
                          secretKeyRef:
                            name: foodfast-secrets
                            key: CLOUDINARY_API_SECRET
                    livenessProbe:
                      httpGet:
                        path: /health
                        port: 5000
                      initialDelaySeconds: 30
                      periodSeconds: 10
                    readinessProbe:
                      httpGet:
                        path: /health
                        port: 5000
                      initialDelaySeconds: 10
                      periodSeconds: 5
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "250m"
                      limits:
                        memory: "512Mi"
                        cpu: "500m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: foodfast-server
            namespace: foodfast
            annotations:
              service.beta.kubernetes.io/aws-load-balancer-type: nlb
          spec:
            type: LoadBalancer
            selector:
              app: foodfast-server
            ports:
              - port: 5000
                targetPort: 5000
          EOF
          
          # Client
          cat > k8s-deploy/03-client.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foodfast-client
            namespace: foodfast
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: foodfast-client
            template:
              metadata:
                labels:
                  app: foodfast-client
              spec:
                imagePullSecrets:
                  - name: ghcr-secret
                containers:
                  - name: client
                    image: ${REGISTRY}/${OWNER}/foodfast-client:${IMAGE_TAG}
                    ports:
                      - containerPort: 80
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "100m"
                      limits:
                        memory: "256Mi"
                        cpu: "200m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: foodfast-client
            namespace: foodfast
            annotations:
              service.beta.kubernetes.io/aws-load-balancer-type: nlb
          spec:
            type: LoadBalancer
            selector:
              app: foodfast-client
            ports:
              - port: 80
                targetPort: 80
          EOF
          
          # Admin
          cat > k8s-deploy/04-admin.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foodfast-admin
            namespace: foodfast
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: foodfast-admin
            template:
              metadata:
                labels:
                  app: foodfast-admin
              spec:
                imagePullSecrets:
                  - name: ghcr-secret
                containers:
                  - name: admin
                    image: ${REGISTRY}/${OWNER}/foodfast-admin:${IMAGE_TAG}
                    ports:
                      - containerPort: 80
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "100m"
                      limits:
                        memory: "256Mi"
                        cpu: "200m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: foodfast-admin
            namespace: foodfast
            annotations:
              service.beta.kubernetes.io/aws-load-balancer-type: nlb
          spec:
            type: LoadBalancer
            selector:
              app: foodfast-admin
            ports:
              - port: 80
                targetPort: 80
          EOF
          
          # Restaurant
          cat > k8s-deploy/05-restaurant.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foodfast-restaurant
            namespace: foodfast
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: foodfast-restaurant
            template:
              metadata:
                labels:
                  app: foodfast-restaurant
              spec:
                imagePullSecrets:
                  - name: ghcr-secret
                containers:
                  - name: restaurant
                    image: ${REGISTRY}/${OWNER}/foodfast-restaurant:${IMAGE_TAG}
                    ports:
                      - containerPort: 80
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "100m"
                      limits:
                        memory: "256Mi"
                        cpu: "200m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: foodfast-restaurant
            namespace: foodfast
            annotations:
              service.beta.kubernetes.io/aws-load-balancer-type: nlb
          spec:
            type: LoadBalancer
            selector:
              app: foodfast-restaurant
            ports:
              - port: 80
                targetPort: 80
          EOF
          
          # Drone
          cat > k8s-deploy/06-drone.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: foodfast-drone
            namespace: foodfast
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: foodfast-drone
            template:
              metadata:
                labels:
                  app: foodfast-drone
              spec:
                imagePullSecrets:
                  - name: ghcr-secret
                containers:
                  - name: drone
                    image: ${REGISTRY}/${OWNER}/foodfast-drone:${IMAGE_TAG}
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "100m"
                      limits:
                        memory: "256Mi"
                        cpu: "200m"
          EOF
          
          # Monitoring - Prometheus
          cat > k8s-deploy/07-prometheus.yaml <<EOF
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: prometheus-config
            namespace: foodfast
          data:
            prometheus.yml: |
              global:
                scrape_interval: 15s
                evaluation_interval: 15s
              scrape_configs:
                - job_name: 'kubernetes-pods'
                  kubernetes_sd_configs:
                    - role: pod
                      namespaces:
                        names:
                          - foodfast
                  relabel_configs:
                    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
                      action: keep
                      regex: true
                    - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
                      action: replace
                      target_label: __metrics_path__
                      regex: (.+)
                    - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
                      action: replace
                      regex: ([^:]+)(?::\d+)?;(\d+)
                      replacement: \$1:\$2
                      target_label: __address__
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: prometheus
            namespace: foodfast
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: prometheus
            template:
              metadata:
                labels:
                  app: prometheus
              spec:
                containers:
                  - name: prometheus
                    image: prom/prometheus:latest
                    ports:
                      - containerPort: 9090
                    volumeMounts:
                      - name: config
                        mountPath: /etc/prometheus
                    resources:
                      requests:
                        memory: "512Mi"
                        cpu: "250m"
                      limits:
                        memory: "1Gi"
                        cpu: "500m"
                volumes:
                  - name: config
                    configMap:
                      name: prometheus-config
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: prometheus
            namespace: foodfast
            annotations:
              service.beta.kubernetes.io/aws-load-balancer-type: nlb
          spec:
            type: LoadBalancer
            selector:
              app: prometheus
            ports:
              - port: 9090
                targetPort: 9090
          EOF
          
          # Monitoring - Grafana
          cat > k8s-deploy/08-grafana.yaml <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: grafana
            namespace: foodfast
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: grafana
            template:
              metadata:
                labels:
                  app: grafana
              spec:
                containers:
                  - name: grafana
                    image: grafana/grafana:latest
                    ports:
                      - containerPort: 3000
                    env:
                      - name: GF_SECURITY_ADMIN_PASSWORD
                        value: "admin123"
                      - name: GF_USERS_ALLOW_SIGN_UP
                        value: "false"
                    resources:
                      requests:
                        memory: "256Mi"
                        cpu: "200m"
                      limits:
                        memory: "512Mi"
                        cpu: "400m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: grafana
            namespace: foodfast
            annotations:
              service.beta.kubernetes.io/aws-load-balancer-type: nlb
          spec:
            type: LoadBalancer
            selector:
              app: grafana
            ports:
              - port: 3000
                targetPort: 3000
          EOF
          
          echo "‚úÖ K8s manifests generated in k8s-deploy/"

      # ======================
      # 7) Apply manifests to EKS
      # ======================
      - name: Deploy to EKS
        run: |
          echo "üöÄ Deploying to EKS cluster: ${{ env.CLUSTER_NAME }}"
          
          # Apply all manifests
          kubectl apply -f k8s-deploy/
          
          # Wait for deployments
          echo "‚è≥ Waiting for deployments to be ready..."
          kubectl wait --for=condition=available --timeout=300s deployment --all -n foodfast || true
          
          # Show status
          echo "üìä Deployment status:"
          kubectl get all -n foodfast
          
          echo "‚úÖ EKS deployment complete!"

      # ======================
      # 8) Get LoadBalancer URLs
      # ======================
      - name: Get LoadBalancer URLs
        run: |
          echo "‚è≥ Waiting for LoadBalancers to provision..."
          sleep 30
          
          echo ""
          echo "üåê LoadBalancer URLs:"
          echo "===================="
          
          SERVER_LB=$(kubectl get svc foodfast-server -n foodfast -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending...")
          echo "Backend API:  http://${SERVER_LB}:5000"
          
          CLIENT_LB=$(kubectl get svc foodfast-client -n foodfast -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending...")
          echo "Client:       http://${CLIENT_LB}"
          
          ADMIN_LB=$(kubectl get svc foodfast-admin -n foodfast -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending...")
          echo "Admin:        http://${ADMIN_LB}"
          
          RESTAURANT_LB=$(kubectl get svc foodfast-restaurant -n foodfast -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending...")
          echo "Restaurant:   http://${RESTAURANT_LB}"
          
          PROMETHEUS_LB=$(kubectl get svc prometheus -n foodfast -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending...")
          echo "Prometheus:   http://${PROMETHEUS_LB}:9090"
          
          GRAFANA_LB=$(kubectl get svc grafana -n foodfast -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending...")
          echo "Grafana:      http://${GRAFANA_LB}:3000"
          
          echo ""
          echo "Note: LoadBalancers may take 2-3 minutes to fully provision"

      # ======================
      # 9) Healthcheck
      # ======================
      - name: Healthcheck backend
        run: |
          echo "‚è≥ Waiting for backend to be ready..."
          sleep 60
          
          SERVER_LB=$(kubectl get svc foodfast-server -n foodfast -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          if [ -z "$SERVER_LB" ]; then
            echo "‚ö†Ô∏è  LoadBalancer not ready yet, skipping healthcheck"
            exit 0
          fi
          
          for i in {1..10}; do
            echo "Attempt $i"
            if curl -f http://${SERVER_LB}:5000/health || \
               curl -f http://${SERVER_LB}:5000/api/health || \
               curl -f http://${SERVER_LB}:5000/ ; then
              echo "‚úÖ Backend is healthy"
              exit 0
            fi
            sleep 10
          done
          
          echo "‚ö†Ô∏è  Backend healthcheck inconclusive (may still be starting)"
          exit 0

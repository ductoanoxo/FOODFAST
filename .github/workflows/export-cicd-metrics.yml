name: Export CI/CD Metrics to Prometheus

on:
  workflow_run:
    workflows:
      - 'CI - Test and Lint (Deploy Branch - Testing Conflict)'
      - 'Docker Build and Push'
      - 'Auto Deploy Foodfast to EC2'
    types:
      - completed
    branches:
      - main
      - kiet
      - DUCTOAN
      - deploy
  workflow_dispatch:

jobs:
  export-metrics:
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main  # Always use latest code from main branch

      - name: Setup SSH (for fallback push via server)
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add EC2 to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Get workflow information
        id: workflow-info
        run: |
          WORKFLOW_NAME="${{ github.event.workflow_run.name || github.workflow }}"
          WORKFLOW_CONCLUSION="${{ github.event.workflow_run.conclusion || 'unknown' }}"
          WORKFLOW_DURATION=0
          BRANCH="${{ github.event.workflow_run.head_branch || github.ref_name }}"
          RUN_ID="${{ github.event.workflow_run.id || github.run_id }}"
          RUN_NUMBER="${{ github.event.workflow_run.run_number || github.run_number }}"
          ACTOR="${{ github.event.workflow_run.actor.login || github.actor }}"
          
          # TÃ­nh duration náº¿u cÃ³
          if [ "${{ github.event.workflow_run.created_at }}" != "" ] && [ "${{ github.event.workflow_run.updated_at }}" != "" ]; then
            START=$(date -d "${{ github.event.workflow_run.created_at }}" +%s)
            END=$(date -d "${{ github.event.workflow_run.updated_at }}" +%s)
            WORKFLOW_DURATION=$((END - START))
          fi
          
          echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
          echo "conclusion=$WORKFLOW_CONCLUSION" >> $GITHUB_OUTPUT
          echo "duration=$WORKFLOW_DURATION" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "run_number=$RUN_NUMBER" >> $GITHUB_OUTPUT
          echo "actor=$ACTOR" >> $GITHUB_OUTPUT

      - name: Generate Prometheus metrics
        env:
          WORKFLOW_NAME: ${{ steps.workflow-info.outputs.workflow_name }}
          CONCLUSION: ${{ steps.workflow-info.outputs.conclusion }}
          DURATION: ${{ steps.workflow-info.outputs.duration }}
          BRANCH: ${{ steps.workflow-info.outputs.branch }}
          RUN_ID: ${{ steps.workflow-info.outputs.run_id }}
          RUN_NUMBER: ${{ steps.workflow-info.outputs.run_number }}
          ACTOR: ${{ steps.workflow-info.outputs.actor }}
        run: |
          # For counters: always increment by 1 (never reset to 0 or decrease)
          # Pushgateway will persist and accumulate the values
          if [ "$CONCLUSION" = "success" ]; then
            SUCCESS_INCREMENT=1
            FAILURE_INCREMENT=0
          elif [ "$CONCLUSION" = "failure" ]; then
            SUCCESS_INCREMENT=0
            FAILURE_INCREMENT=1
          else
            SUCCESS_INCREMENT=0
            FAILURE_INCREMENT=0
          fi
          
          cat > metrics.txt <<'EOF'
# HELP github_workflow_run_total Total number of workflow runs (counter)
# TYPE github_workflow_run_total counter
github_workflow_run_total{workflow="WORKFLOW_NAME_PLACEHOLDER",branch="BRANCH_PLACEHOLDER",actor="ACTOR_PLACEHOLDER"} 1

# HELP github_workflow_success_total Total number of successful workflow runs (counter)
# TYPE github_workflow_success_total counter
github_workflow_success_total{workflow="WORKFLOW_NAME_PLACEHOLDER",branch="BRANCH_PLACEHOLDER"} SUCCESS_INCREMENT_PLACEHOLDER

# HELP github_workflow_failure_total Total number of failed workflow runs (counter)
# TYPE github_workflow_failure_total counter
github_workflow_failure_total{workflow="WORKFLOW_NAME_PLACEHOLDER",branch="BRANCH_PLACEHOLDER"} FAILURE_INCREMENT_PLACEHOLDER

# HELP github_workflow_duration_seconds Duration of workflow run in seconds
# TYPE github_workflow_duration_seconds gauge
github_workflow_duration_seconds{workflow="WORKFLOW_NAME_PLACEHOLDER",branch="BRANCH_PLACEHOLDER",conclusion="CONCLUSION_PLACEHOLDER"} DURATION_PLACEHOLDER

# HELP github_workflow_run_number Sequential run number of the workflow
# TYPE github_workflow_run_number gauge
github_workflow_run_number{workflow="WORKFLOW_NAME_PLACEHOLDER",branch="BRANCH_PLACEHOLDER"} RUN_NUMBER_PLACEHOLDER

# HELP github_workflow_status Current status of workflow (1=success, 0=failure, -1=unknown)
# TYPE github_workflow_status gauge
github_workflow_status{workflow="WORKFLOW_NAME_PLACEHOLDER",branch="BRANCH_PLACEHOLDER",run_id="RUN_ID_PLACEHOLDER"} STATUS_PLACEHOLDER
EOF

          # Replace placeholders with actual values
          sed -i "s/WORKFLOW_NAME_PLACEHOLDER/$WORKFLOW_NAME/g" metrics.txt
          sed -i "s/BRANCH_PLACEHOLDER/$BRANCH/g" metrics.txt
          sed -i "s/ACTOR_PLACEHOLDER/$ACTOR/g" metrics.txt
          sed -i "s/SUCCESS_INCREMENT_PLACEHOLDER/$SUCCESS_INCREMENT/g" metrics.txt
          sed -i "s/FAILURE_INCREMENT_PLACEHOLDER/$FAILURE_INCREMENT/g" metrics.txt
          sed -i "s/CONCLUSION_PLACEHOLDER/$CONCLUSION/g" metrics.txt
          sed -i "s/DURATION_PLACEHOLDER/$DURATION/g" metrics.txt
          sed -i "s/RUN_NUMBER_PLACEHOLDER/$RUN_NUMBER/g" metrics.txt
          sed -i "s/RUN_ID_PLACEHOLDER/$RUN_ID/g" metrics.txt
          
          # Calculate status value
          if [ "$CONCLUSION" = "success" ]; then
            STATUS=1
          elif [ "$CONCLUSION" = "failure" ]; then
            STATUS=0
          else
            STATUS=-1
          fi
          sed -i "s/STATUS_PLACEHOLDER/$STATUS/g" metrics.txt
          
          echo "Generated metrics:"
          cat metrics.txt

      - name: Push metrics to Pushgateway
        env:
          PUSHGATEWAY_URL: ${{ secrets.PUSHGATEWAY_URL || 'http://13.220.101.54:9091' }}
          WORKFLOW_NAME: ${{ steps.workflow-info.outputs.workflow_name }}
          SERVER_HOST: ${{ secrets.PROD_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PROD_SERVER_USER }}
        run: |
          # Sanitize workflow name for Prometheus job label
          JOB_NAME=$(echo "$WORKFLOW_NAME" | tr ' ' '_' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_]/_/g')
          
          echo "=========================================="
          echo "Pushing metrics to Pushgateway"
          echo "=========================================="
          echo "URL: $PUSHGATEWAY_URL"
          echo "Job: github_actions"
          echo "Original Workflow Name: $WORKFLOW_NAME"
          echo "Sanitized Job Name: $JOB_NAME"
          
          # CRITICAL: Create unique instance with timestamp
          TIMESTAMP=$(date +%s)
          INSTANCE="${JOB_NAME}_${TIMESTAMP}"
          
          echo "Instance: $INSTANCE"
          echo "Timestamp: $TIMESTAMP"
          echo "=========================================="
          
          # Show metrics to be pushed
          echo "Metrics to push:"
          cat metrics.txt
          echo "=========================================="
          
          # Try direct push first (if Pushgateway is publicly accessible)
          PUSH_URL="${PUSHGATEWAY_URL}/metrics/job/github_actions/instance/${INSTANCE}"
          echo "Attempting direct push to: $PUSH_URL"
          
          HTTP_CODE=$(curl -w "%{http_code}" -o /tmp/response.txt --connect-timeout 5 --max-time 10 --data-binary @metrics.txt "$PUSH_URL" 2>/dev/null || echo "000")
          
          echo "HTTP Response Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "âœ… Metrics pushed successfully via direct connection!"
          else
            echo "âš ï¸  Direct push failed or timed out (HTTP $HTTP_CODE)"
            echo "Attempting to push via SSH to EC2 server..."
            
            # Copy metrics file to server and push from there (using ssh-agent)
            scp metrics.txt $SERVER_USER@$SERVER_HOST:/tmp/github_metrics_${TIMESTAMP}.txt
            
            # Push from server (Pushgateway is on localhost in EC2)
            ssh $SERVER_USER@$SERVER_HOST "curl --data-binary @/tmp/github_metrics_${TIMESTAMP}.txt 'http://localhost:9091/metrics/job/github_actions/instance/${INSTANCE}' && rm /tmp/github_metrics_${TIMESTAMP}.txt && echo 'âœ… Pushed from server successfully'"
            
            echo "âœ… Metrics pushed successfully via SSH!"
          fi
          
          echo "=========================================="
          echo "Verifying metrics in Pushgateway:"
          curl -s "http://${SERVER_HOST}:9091/metrics" 2>/dev/null | grep "instance=\"${INSTANCE}\"" | head -3 || echo "Metrics will appear shortly..."

      - name: Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸ“Š CI/CD Metrics Export
          
          - **Workflow**: ${{ steps.workflow-info.outputs.workflow_name }}
          - **Conclusion**: ${{ steps.workflow-info.outputs.conclusion }}
          - **Duration**: ${{ steps.workflow-info.outputs.duration }}s
          - **Branch**: ${{ steps.workflow-info.outputs.branch }}
          - **Run**: #${{ steps.workflow-info.outputs.run_number }}
          - **Actor**: ${{ steps.workflow-info.outputs.actor }}
          
          ### ðŸ“ Instance Label
          Generated with timestamp for unique time series in Grafana.
          
          ### ðŸ”— View Metrics
          - [Pushgateway](http://13.220.101.54:9091)
          - [Prometheus](http://13.220.101.54:9090)
          - [Grafana Dashboard](http://13.220.101.54:3030)
          
          Metrics are now available for real-time visualization! ðŸŽ‰
          EOF

name: Export CI/CD Metrics to Prometheus

on:
  workflow_run:
    workflows:
      - "CI - Test and Lint (Deploy Branch - Testing Conflict)"
      - "Docker Build and Push"
      - "Auto Deploy Foodfast to EC2"
    types:
      - completed

jobs:
  export-metrics:
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract workflow metrics
        id: metrics
        run: |
          # Láº¥y thÃ´ng tin workflow
          WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
          WORKFLOW_STATUS="${{ github.event.workflow_run.conclusion }}"
          WORKFLOW_DURATION=${{ github.event.workflow_run.updated_at }}
          WORKFLOW_CREATED=${{ github.event.workflow_run.created_at }}
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          REPO="${{ github.repository }}"
          RUN_ID="${{ github.event.workflow_run.id }}"
          RUN_NUMBER="${{ github.event.workflow_run.run_number }}"
          ACTOR="${{ github.event.workflow_run.actor.login }}"
          
          # TÃ­nh duration (giÃ¢y)
          CREATED_TS=$(date -d "${{ github.event.workflow_run.created_at }}" +%s)
          UPDATED_TS=$(date -d "${{ github.event.workflow_run.updated_at }}" +%s)
          DURATION=$((UPDATED_TS - CREATED_TS))
          
          # Chuyá»ƒn status sang sá»‘ (0=success, 1=failure, 2=cancelled, 3=skipped)
          case "$WORKFLOW_STATUS" in
            success) STATUS_CODE=0 ;;
            failure) STATUS_CODE=1 ;;
            cancelled) STATUS_CODE=2 ;;
            skipped) STATUS_CODE=3 ;;
            *) STATUS_CODE=4 ;;
          esac
          
          echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
          echo "status=$WORKFLOW_STATUS" >> $GITHUB_OUTPUT
          echo "status_code=$STATUS_CODE" >> $GITHUB_OUTPUT
          echo "duration=$DURATION" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "run_number=$RUN_NUMBER" >> $GITHUB_OUTPUT
          echo "actor=$ACTOR" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Workflow: $WORKFLOW_NAME"
          echo "ðŸ“Š Status: $WORKFLOW_STATUS ($STATUS_CODE)"
          echo "ðŸ“Š Duration: ${DURATION}s"
          echo "ðŸ“Š Branch: $BRANCH"
          echo "ðŸ“Š Run: #$RUN_NUMBER"

      - name: Push metrics to Pushgateway
        env:
          PUSHGATEWAY_URL: ${{ secrets.PUSHGATEWAY_URL || 'http://13.220.101.54:9091' }}
        run: |
          WORKFLOW_NAME="${{ steps.metrics.outputs.workflow_name }}"
          STATUS="${{ steps.metrics.outputs.status }}"
          STATUS_CODE="${{ steps.metrics.outputs.status_code }}"
          DURATION="${{ steps.metrics.outputs.duration }}"
          BRANCH="${{ steps.metrics.outputs.branch }}"
          REPO="${{ steps.metrics.outputs.repo }}"
          RUN_ID="${{ steps.metrics.outputs.run_id }}"
          RUN_NUMBER="${{ steps.metrics.outputs.run_number }}"
          ACTOR="${{ steps.metrics.outputs.actor }}"
          
          # Escape workflow name cho URL
          WORKFLOW_NAME_ESCAPED=$(echo "$WORKFLOW_NAME" | sed 's/ /_/g')
          
          # Táº¡o metrics trong format Prometheus
          cat <<EOF | curl --data-binary @- "${PUSHGATEWAY_URL}/metrics/job/github_actions/instance/${WORKFLOW_NAME_ESCAPED}/branch/${BRANCH}"
          # HELP github_workflow_run_status Status of GitHub Actions workflow run (0=success, 1=failure, 2=cancelled, 3=skipped, 4=other)
          # TYPE github_workflow_run_status gauge
          github_workflow_run_status{workflow="${WORKFLOW_NAME}",repo="${REPO}",branch="${BRANCH}",status="${STATUS}",actor="${ACTOR}",run_id="${RUN_ID}",run_number="${RUN_NUMBER}"} ${STATUS_CODE}
          
          # HELP github_workflow_run_duration_seconds Duration of GitHub Actions workflow run in seconds
          # TYPE github_workflow_run_duration_seconds gauge
          github_workflow_run_duration_seconds{workflow="${WORKFLOW_NAME}",repo="${REPO}",branch="${BRANCH}",status="${STATUS}",actor="${ACTOR}",run_id="${RUN_ID}",run_number="${RUN_NUMBER}"} ${DURATION}
          
          # HELP github_workflow_run_timestamp_seconds Timestamp when workflow run completed
          # TYPE github_workflow_run_timestamp_seconds gauge
          github_workflow_run_timestamp_seconds{workflow="${WORKFLOW_NAME}",repo="${REPO}",branch="${BRANCH}",status="${STATUS}",actor="${ACTOR}",run_id="${RUN_ID}",run_number="${RUN_NUMBER}"} $(date +%s)
          
          # HELP github_workflow_run_count_total Total count of workflow runs
          # TYPE github_workflow_run_count_total counter
          github_workflow_run_count_total{workflow="${WORKFLOW_NAME}",repo="${REPO}",branch="${BRANCH}",status="${STATUS}"} 1
          
          # HELP github_workflow_run_success_total Total count of successful workflow runs
          # TYPE github_workflow_run_success_total counter
          github_workflow_run_success_total{workflow="${WORKFLOW_NAME}",repo="${REPO}",branch="${BRANCH}"} $([[ "${STATUS}" == "success" ]] && echo "1" || echo "0")
          
          # HELP github_workflow_run_failure_total Total count of failed workflow runs
          # TYPE github_workflow_run_failure_total counter
          github_workflow_run_failure_total{workflow="${WORKFLOW_NAME}",repo="${REPO}",branch="${BRANCH}"} $([[ "${STATUS}" == "failure" ]] && echo "1" || echo "0")
          EOF
          
          if [ $? -eq 0 ]; then
            echo "âœ… Metrics pushed successfully to ${PUSHGATEWAY_URL}"
          else
            echo "âŒ Failed to push metrics to ${PUSHGATEWAY_URL}"
            exit 1
          fi

      - name: Push deployment metrics (if deploy workflow)
        if: contains(steps.metrics.outputs.workflow_name, 'Deploy')
        env:
          PUSHGATEWAY_URL: ${{ secrets.PUSHGATEWAY_URL || 'http://13.220.101.54:9091' }}
        run: |
          WORKFLOW_NAME="${{ steps.metrics.outputs.workflow_name }}"
          STATUS="${{ steps.metrics.outputs.status }}"
          STATUS_CODE="${{ steps.metrics.outputs.status_code }}"
          BRANCH="${{ steps.metrics.outputs.branch }}"
          REPO="${{ steps.metrics.outputs.repo }}"
          
          cat <<EOF | curl --data-binary @- "${PUSHGATEWAY_URL}/metrics/job/github_deployments/instance/production/branch/${BRANCH}"
          # HELP github_deployment_status Status of deployment (0=success, 1=failure)
          # TYPE github_deployment_status gauge
          github_deployment_status{workflow="${WORKFLOW_NAME}",repo="${REPO}",branch="${BRANCH}",environment="production"} ${STATUS_CODE}
          
          # HELP github_deployment_timestamp_seconds Timestamp of last deployment
          # TYPE github_deployment_timestamp_seconds gauge
          github_deployment_timestamp_seconds{workflow="${WORKFLOW_NAME}",repo="${REPO}",branch="${BRANCH}",environment="production"} $(date +%s)
          
          # HELP github_deployment_count_total Total deployments
          # TYPE github_deployment_count_total counter
          github_deployment_count_total{workflow="${WORKFLOW_NAME}",repo="${REPO}",branch="${BRANCH}",environment="production",status="${STATUS}"} 1
          EOF
          
          echo "âœ… Deployment metrics pushed"

      - name: Create deployment summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## ðŸ“Š CI/CD Metrics Exported
          
          - **Workflow**: ${{ steps.metrics.outputs.workflow_name }}
          - **Status**: ${{ steps.metrics.outputs.status }} 
          - **Duration**: ${{ steps.metrics.outputs.duration }}s
          - **Branch**: ${{ steps.metrics.outputs.branch }}
          - **Run**: #${{ steps.metrics.outputs.run_number }}
          - **Actor**: ${{ steps.metrics.outputs.actor }}
          - **Pushgateway**: ${PUSHGATEWAY_URL:-http://13.220.101.54:9091}
          
          ### ðŸ”— Quick Links
          - [Prometheus](${{ secrets.PROMETHEUS_URL || 'http://13.220.101.54:9090' }})
          - [Grafana Dashboard](${{ secrets.GRAFANA_URL || 'http://13.220.101.54:3030' }}/d/cicd-metrics/cicd-pipeline-metrics)
          - [Pushgateway Metrics](${{ secrets.PUSHGATEWAY_URL || 'http://13.220.101.54:9091' }}/metrics)
          
          Metrics are now available in real-time on Grafana! ðŸ“ˆ
          EOF

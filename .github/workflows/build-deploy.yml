name: Build & Auto Deploy Foodfast

on:
  # chạy sau khi CI xong cho các nhánh này
  workflow_run:
    workflows:
      - CI - Test and Lint (Deploy Branch - Testing Conflict)
    types:
      - completed
    branches:
      - main
      - develop
      - DUCTOAN
      - deploy
      - kiet

  # cho phép chạy tay
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}
  OWNER: ${{ github.repository_owner }}

jobs:
  # =====================================================
  # 1) BUILD & PUSH
  # =====================================================
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    # chạy khi:
    # - là workflow_run và CI thành công
    # - HOẶC là workflow_dispatch
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')

    outputs:
      # branch thật để job deploy dùng
      head_branch: ${{ steps.detect-branch.outputs.head_branch }}
      # commit để deploy (nếu cần)
      head_sha: ${{ steps.detect-branch.outputs.head_sha }}

    strategy:
      matrix:
        service:
          - name: client_app
            image: foodfast-client
          - name: restaurant_app
            image: foodfast-restaurant
          - name: admin_app
            image: foodfast-admin
          - name: drone_manage
            image: foodfast-drone
          - name: server_app
            image: foodfast-server

    steps:
      # Cần xác định trước: đang là workflow_run hay chạy tay
      - name: Detect branch / sha
        id: detect-branch
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            SHA="${{ github.event.workflow_run.head_sha }}"
          else
            # workflow_dispatch hoặc chạy bình thường
            # github.ref_name chỉ có từ Actions mới
            BRANCH="${{ github.ref_name }}"
            SHA="${{ github.sha }}"
          fi

          echo "head_branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "head_sha=$SHA" >> $GITHUB_OUTPUT

          echo "Detected branch: $BRANCH"
          echo "Detected sha: $SHA"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # nếu là workflow_run thì checkout đúng commit vừa build/test
          ref: ${{ steps.detect-branch.outputs.head_sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.image }}
          tags: |
            # từ branch / PR của workflow trước
            type=ref,event=branch
            type=ref,event=pr
            # nếu workflow trước được trigger bởi tag
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            # tránh tag bắt đầu bằng dấu -
            type=sha
            # chỉ branch default mới là latest (thường là main)
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service.name }}
          file: ./${{ matrix.service.name }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.image }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.image }}:buildcache,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            VITE_API_URL=${{ secrets.VITE_API_URL || 'http://54.221.100.67:5000/api' }}
            VITE_SOCKET_URL=${{ secrets.VITE_SOCKET_URL || 'http://54.221.100.67:5000' }}

      - name: Image digest
        run: echo ${{ steps.meta.outputs.digest }}

  # =====================================================
  # 2) DEPLOY (chỉ khi branch == main)
  # =====================================================
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    # chỉ deploy khi:
    # - là workflow_run và CI nhánh main
    # HOẶC
    # - là workflow_dispatch nhưng HEAD đang là main
    if: |
      (github.event_name == 'workflow_run' &&
       needs.build-and-push.outputs.head_branch == 'main') ||
      (github.event_name == 'workflow_dispatch' &&
       needs.build-and-push.outputs.head_branch == 'main')

    steps:
      # Nếu cần xem lại code / script
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.build-and-push.outputs.head_sha }}

      # ======================
      # 1) Decide image tag
      # ======================
      - name: Decide image tag
        id: imagetag
        run: |
          # Vì chỉ deploy main nên ta lấy latest
          TAG="latest"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "✅ Will deploy image tag: $TAG (main only)"

      # ======================
      # 2) SSH Setup
      # ======================
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

      - name: Add EC2 to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts

      # ======================
      # 3) Create remote script
      # ======================
      - name: Create remote script
        run: |
          cat > remote-deploy.sh <<'SCRIPT'
          set -e

          REGISTRY="${REGISTRY}"
          OWNER="${OWNER}"
          IMAGE_TAG="${IMAGE_TAG}"
          GHCR_TOKEN="${GHCR_TOKEN}"
          MONGO_URI="${MONGO_URI}"
          JWT_SECRET="${JWT_SECRET}"
          JWT_EXPIRE="${JWT_EXPIRE}"

          echo "==> Login GHCR as \$OWNER"
          echo "${GHCR_TOKEN}" | sudo docker login ghcr.io -u "${OWNER}" --password-stdin

          echo "==> Create network"
          sudo docker network create foodfast-net || true

          echo "=== Deploy foodfast-server:\${IMAGE_TAG} ==="
          sudo docker pull "${REGISTRY}/${OWNER}/foodfast-server:${IMAGE_TAG}"
          sudo docker rm -f foodfast-server 2>/dev/null || true
          sudo docker run -d --name foodfast-server --restart unless-stopped \
            --network foodfast-net --network-alias server_app \
            -p 5000:5000 \
            -e MONGO_URI="${MONGO_URI}" \
            -e JWT_SECRET="${JWT_SECRET}" \
            -e JWT_EXPIRE="${JWT_EXPIRE}" \
            -e NODE_ENV="production" \
            -e PORT="5000" \
            "${REGISTRY}/${OWNER}/foodfast-server:${IMAGE_TAG}"

          echo "=== Deploy foodfast-client:\${IMAGE_TAG} ==="
          sudo docker pull "${REGISTRY}/${OWNER}/foodfast-client:${IMAGE_TAG}"
          sudo docker rm -f foodfast-client 2>/dev/null || true
          sudo docker run -d --name foodfast-client --restart unless-stopped \
            --network foodfast-net \
            -p 3000:80 \
            "${REGISTRY}/${OWNER}/foodfast-client:${IMAGE_TAG}"

          echo "=== Deploy foodfast-admin:\${IMAGE_TAG} ==="
          sudo docker pull "${REGISTRY}/${OWNER}/foodfast-admin:${IMAGE_TAG}"
          sudo docker rm -f foodfast-admin 2>/dev/null || true
          sudo docker run -d --name foodfast-admin --restart unless-stopped \
            --network foodfast-net \
            -p 3001:80 \
            "${REGISTRY}/${OWNER}/foodfast-admin:${IMAGE_TAG}"

          echo "=== Deploy foodfast-restaurant:\${IMAGE_TAG} ==="
          sudo docker pull "${REGISTRY}/${OWNER}/foodfast-restaurant:${IMAGE_TAG}"
          sudo docker rm -f foodfast-restaurant 2>/dev/null || true
          sudo docker run -d --name foodfast-restaurant --restart unless-stopped \
            --network foodfast-net \
            -p 3002:80 \
            "${REGISTRY}/${OWNER}/foodfast-restaurant:${IMAGE_TAG}"

          echo "=== Deploy foodfast-drone:\${IMAGE_TAG} ==="
          sudo docker pull "${REGISTRY}/${OWNER}/foodfast-drone:${IMAGE_TAG}"
          sudo docker rm -f foodfast-drone 2>/dev/null || true
          sudo docker run -d --name foodfast-drone --restart unless-stopped \
            --network foodfast-net \
            "${REGISTRY}/${OWNER}/foodfast-drone:${IMAGE_TAG}"

          echo "✅ Deploy done."
          SCRIPT

      # ======================
      # 4) Run remote script on EC2
      # ======================
      - name: Run remote script on EC2
        env:
          SERVER_HOST: ${{ secrets.PROD_SERVER_HOST }}
          SERVER_USER: ${{ secrets.PROD_SERVER_USER }}
          REGISTRY: ${{ env.REGISTRY }}
          OWNER: ${{ env.OWNER }}
          IMAGE_TAG: ${{ steps.imagetag.outputs.tag }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          MONGO_URI: ${{ secrets.MONGO_URI }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRE: ${{ secrets.JWT_EXPIRE }}
        run: |
          echo "Connecting to $SERVER_USER@$SERVER_HOST ..."
          echo "Deploying with image tag: ${IMAGE_TAG}"

          scp remote-deploy.sh $SERVER_USER@$SERVER_HOST:/tmp/remote-deploy.sh

          ssh $SERVER_USER@$SERVER_HOST "chmod +x /tmp/remote-deploy.sh && \
            REGISTRY='${REGISTRY}' \
            OWNER='${OWNER}' \
            IMAGE_TAG='${IMAGE_TAG}' \
            GHCR_TOKEN='${GHCR_TOKEN}' \
            MONGO_URI='${MONGO_URI}' \
            JWT_SECRET='${JWT_SECRET}' \
            JWT_EXPIRE='${JWT_EXPIRE}' \
            /tmp/remote-deploy.sh"

      # ======================
      # 5) Healthcheck
      # ======================
      - name: Healthcheck backend
        run: |
          echo "Waiting for backend..."
          for i in {1..6}; do
            echo "Attempt $i"
            if curl -f http://${{ secrets.PROD_SERVER_HOST }}:5000/health \
              || curl -f http://${{ secrets.PROD_SERVER_HOST }}:5000/api/health \
              || curl -f http://${{ secrets.PROD_SERVER_HOST }}:5000/ ; then
              echo "✅ Backend is up"
              exit 0
            fi
            sleep 5
          done
          echo "❌ Backend is NOT responding on port 5000"
          exit 1
